---
import Layout from '@/layouts/Layout.astro';
import ProductCard from '@/components/ProductCard.astro';
import { supabase } from '@/lib/supabase';

// Obtener parámetro de búsqueda
const query = new URL(Astro.request.url).searchParams.get('q') || '';

let searchResults: any[] = [];
let totalResults = 0;

if (query.trim()) {
  try {
    // Buscar en la BD
    const { data: products, error } = await supabase
      .from('productos')
      .select('*')
      .or(`nombre.ilike.%${query}%,descripcion.ilike.%${query}%,categoria.ilike.%${query}%`)
      .eq('estado', 'activo')
      .limit(50);

    if (error) {
      console.error('Error fetching products:', error);
      searchResults = [];
    } else {
      searchResults = products || [];
      totalResults = searchResults.length;
    }
  } catch (err) {
    console.error('Search error:', err);
    searchResults = [];
  }
}

const hasResults = searchResults.length > 0;
---

<Layout title={`Búsqueda: ${query} - FashionStore`}>
  <div class="min-h-screen bg-white">
    {/* Header Section - Mejorado */}
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200 py-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-start justify-between">
          <div>
            <h1 class="text-4xl font-black italic text-gray-900 mb-2">
              Resultados de búsqueda
            </h1>
            {query && (
              <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg border border-[#00aa45] shadow-sm">
                  <svg class="w-5 h-5 text-[#00aa45]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <span class="font-semibold text-gray-900">"{query}"</span>
                </div>
                <div class="px-4 py-2 bg-[#00aa45] text-white rounded-lg font-semibold">
                  {hasResults ? (
                    <span>{totalResults} {totalResults === 1 ? 'producto' : 'productos'}</span>
                  ) : (
                    <span>Sin resultados</span>
                  )}
                </div>
              </div>
            )}
            {!query && (
              <p class="text-gray-600 text-lg">Ingresa un término de búsqueda para encontrar productos</p>
            )}
          </div>
        </div>
      </div>
    </div>

    {/* Results Section */}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      {hasResults ? (
        <>
          <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-6">
              Mostrando {totalResults} {totalResults === 1 ? 'producto' : 'productos'} coincidentes
            </h2>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {searchResults.map(product => (
              <ProductCard
                slug={product.slug || String(product.id)}
                name={product.nombre}
                price={product.precio}
                originalPrice={product.precio_original}
                image={product.imagen_principal || 'https://via.placeholder.com/500'}
                rating={product.rating || 4.5}
                reviews={product.resenas || 0}
                condition={product.condicion || 'Muy bueno'}
                badge={product.badge || undefined}
              />
            ))}
          </div>
        </>
      ) : (
        <div class="text-center py-20">
          <div class="mb-8">
            <svg class="w-40 h-40 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <h2 class="text-3xl font-bold text-gray-900 mb-3">
            {query ? 'No se encontraron productos' : 'Comienza tu búsqueda'}
          </h2>
          <p class="text-gray-600 text-lg mb-8 max-w-md mx-auto">
            {query 
              ? `No encontramos productos que coincidan con "${query}". Intenta con otras palabras clave.`
              : 'Usa la barra de búsqueda para encontrar los productos que deseas.'}
          </p>
          <div class="flex gap-4 justify-center flex-wrap">
            <a href="/" class="inline-flex items-center gap-2 bg-[#00aa45] text-white px-8 py-3 rounded-lg font-semibold hover:bg-[#009340] transition duration-200 shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-3m0 0l7-4 7 4M5 9v10a1 1 0 001 1h12a1 1 0 001-1V9m-9 11l4-4m0 0l4 4m-4-4v4" />
              </svg>
              Ir al inicio
            </a>
            <a href="/categoria/smartphones" class="inline-flex items-center gap-2 border-2 border-[#00aa45] text-[#00aa45] px-8 py-3 rounded-lg font-semibold hover:bg-[#f0f9f7] transition duration-200">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Explorar categorías
            </a>
          </div>
        </div>
      )}
    </div>
  </div>
</Layout>
