---
export const prerender = true;
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";

const { slug } = Astro.params;

// Obtener producto de Supabase
const { data: producto } = await supabase
  .from("productos")
  .select(
    `
    id, 
    nombre, 
    slug, 
    descripcion,
    descripcion_larga,
    precio_venta, 
    precio_original, 
    stock_total,
    valoracion_promedio,
    total_resenas,
    imagenes_producto(id, url, alt_text, es_principal),
    marca:marcas(nombre, slug),
    categoria:categorias(nombre, slug)
  `,
  )
  .eq("slug", slug)
  .eq("activo", true)
  .single();

if (!producto) {
  return Astro.redirect("/");
}

// Obtener reseñas verificadas
const { data: resenas } = await supabase
  .from("resenas")
  .select(
    "id, calificacion, titulo, comentario, usuario:usuarios(nombre), creada_en",
  )
  .eq("producto_id", producto.id)
  .eq("estado", "Aprobada")
  .order("creada_en", { ascending: false });

// Obtener imágenes
const imagenes = producto.imagenes_producto || [];
const imagenPrincipal =
  imagenes.find((img: any) => img.es_principal) || imagenes[0];

// Generar rutas estáticas para todos los productos
export async function getStaticPaths() {
  const { data: productos } = await supabase
    .from("productos")
    .select("slug")
    .eq("activo", true);

  return (
    productos?.map((p: any) => ({
      params: { slug: p.slug },
    })) || []
  );
}
---

<Layout title={`${producto.nombre} - FashionStore`}>
  <main class="min-h-screen bg-[#f5f5f7]">
    <!-- Breadcrumb -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <nav class="flex items-center gap-2 text-sm text-gray-600">
        <a href="/" class="hover:text-[#00aa45]">Inicio</a>
        <span>/</span>
        {
          producto.categoria && (
            <>
              <a
                href={`/categoria/${producto.categoria.slug}`}
                class="hover:text-[#00aa45]"
              >
                {producto.categoria.nombre}
              </a>
              <span>/</span>
            </>
          )
        }
        <span class="text-gray-900 font-semibold">{producto.nombre}</span>
      </nav>
    </div>

    <!-- Producto Detalle -->
    <section class="py-12 sm:py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 sm:gap-12">
          <!-- Galería de Imágenes -->
          <div id="product-gallery-container">
            <img
              id="main-product-image"
              src={imagenPrincipal?.url || ""}
              alt={producto.nombre}
              class="w-full h-auto rounded-2xl bg-white shadow-md object-contain p-8"
            />
          </div>

          <!-- Información del Producto -->
          <div class="space-y-6">
            <!-- Categoría -->
            {
              producto.categoria && (
                <a
                  href={`/categoria/${producto.categoria.slug}`}
                  class="inline-block text-sm text-[#00aa45] hover:text-[#009340] font-semibold"
                >
                  {producto.categoria.nombre}
                </a>
              )
            }

            <!-- Título -->
            <h1 class="text-3xl sm:text-4xl font-black text-gray-900">
              {producto.nombre}
            </h1>

            <!-- Marca -->
            {
              producto.marca && (
                <p class="text-lg text-gray-600">
                  Marca:{" "}
                  <span class="font-semibold text-gray-900">
                    {producto.marca.nombre}
                  </span>
                </p>
              )
            }

            <!-- Valoración -->
            {
              (
                <div class="flex items-center gap-4">
                  <div class="flex gap-1">
                    {Array(5)
                      .fill(0)
                      .map((_: any, i: number) => (
                        <svg
                          class={`w-5 h-5 ${i < Math.floor(producto.valoracion_promedio) ? "text-amber-400 fill-amber-400" : "text-gray-300 fill-gray-300"}`}
                          viewBox="0 0 20 20"
                        >
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                      ))}
                  </div>
                  <span class="text-sm text-gray-600">
                    {producto.valoracion_promedio.toFixed(1)} (
                    {producto.total_resenas}{" "}
                    {producto.total_resenas === 1 ? "reseña" : "reseñas"})
                  </span>
                </div>
              )
            }

            <!-- Descripción -->
            <p class="text-gray-700 leading-relaxed mb-6">
              {producto.descripcion}
            </p>

            <!-- Selector de Variantes -->
            <div id="variant-selector-container"></div>

            <!-- Características -->
            {
              producto.descripcion_larga && (
                <div class="border-t border-gray-200 pt-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-3">
                    Descripción Detallada
                  </h3>
                  <p class="text-gray-700 leading-relaxed whitespace-pre-line">
                    {producto.descripcion_larga}
                  </p>
                </div>
              )
            }
          </div>
        </div>

        <!-- Reseñas -->
        {
          resenas && resenas.length > 0 && (
            <div class="mt-16">
              <div class="flex items-center justify-between mb-8">
                <h2 class="text-2xl font-bold text-gray-900">
                  Reseñas de Clientes
                </h2>
              </div>

              <div class="grid gap-6">
                {resenas.slice(0, 5).map((resena: any) => (
                  <div class="bg-white rounded-xl p-6 shadow-sm">
                    <div class="flex items-start justify-between mb-3">
                      <div>
                        <div class="flex gap-1 mb-2">
                          {Array(5)
                            .fill(0)
                            .map((_: any, i: number) => (
                              <svg
                                class={`w-4 h-4 ${i < resena.calificacion ? "text-amber-400 fill-amber-400" : "text-gray-300 fill-gray-300"}`}
                                viewBox="0 0 20 20"
                              >
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                              </svg>
                            ))}
                        </div>
                        <h4 class="font-semibold text-gray-900">
                          {resena.titulo}
                        </h4>
                      </div>
                      <span class="text-sm text-gray-500">
                        {new Date(resena.creada_en).toLocaleDateString("es-ES")}
                      </span>
                    </div>
                    <p class="text-gray-700 mb-3">{resena.comentario}</p>
                    <p class="text-sm text-gray-600">
                      Por {resena.usuario?.nombre || "Usuario"}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )
        }

        <!-- Botón para agregar reseña -->
      </div>
    </section>
  </main>

  <script>
    import VariantSelector from "@/components/VariantSelector";
    import { render, h } from "preact";

    const container = document.getElementById("variant-selector-container");

    const imageElement = document.getElementById(
      "main-product-image",
    ) as HTMLImageElement;
    const productSlug = window.location.pathname.split("/").pop() || "";

    if (container && imageElement) {
      // Usar preact render
      render(
        h(VariantSelector, {
          productSlug: productSlug,
          onImageChange: (imageUrl: string | null) => {
            if (imageUrl) {
              imageElement.src = imageUrl;
            }
          },
        }),
        container,
      );
    }
  </script>
</Layout>
