# ğŸ“Š Diagrama Visual del Sistema de Reservas

## ğŸ—ï¸ Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FRONTEND (React/Astro)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  ProductCard                    CartItem                   Checkout  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ Nombre Producto  â”‚          â”‚ Producto - Qty   â”‚      â”‚ Crear   â”‚
â”‚  â”‚ Stock: 10        â”‚          â”‚ â±ï¸ Expira: 30s   â”‚      â”‚ Pedido  â”‚
â”‚  â”‚ [AÃ±adir al Cart] â”‚          â”‚ [+] [-] [X]      â”‚      â”‚         â”‚
â”‚  â”‚                  â”‚          â”‚                  â”‚      â”‚ [Pagar] â”‚
â”‚  â”‚ onClick â†’        â”‚          â”‚ onChange â†’       â”‚      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
â”‚           â”‚                             â”‚                     â”‚
â”‚           â”‚ POST /api/reservas          â”‚ PUT /api/reservas   â”‚ POST /api/carrito
â”‚           â”‚ {producto, quantity}        â”‚ {producto, qty}     â”‚ {items...}
â”‚           â–¼                             â–¼                     â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP/REST
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (Astro + TypeScript)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              /api/reservas.ts (CRUD Reservas)               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  GET  â†’ reservationClient.getReservations()                 â”‚  â”‚
â”‚  â”‚         â†“ supabase.rpc('get_user_cart_reservations')        â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  POST â†’ reservationClient.createReservation(pid, qty)       â”‚  â”‚
â”‚  â”‚         â†“ supabase.rpc('create_cart_reservation')           â”‚  â”‚
â”‚  â”‚         â†“ Verifica stock                                    â”‚  â”‚
â”‚  â”‚         â†“ Resta stock                                       â”‚  â”‚
â”‚  â”‚         â†“ Crea reserva con expires_at = NOW() + 1min      â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  PUT  â†’ reservationClient.updateReservation(pid, qty)       â”‚  â”‚
â”‚  â”‚         â†“ supabase.rpc('create_cart_reservation')           â”‚  â”‚
â”‚  â”‚         â†“ Ajusta stock segÃºn diferencia                     â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  DELETE â†’ reservationClient.deleteReservation(pid)          â”‚  â”‚
â”‚  â”‚          â†“ supabase.rpc('delete_cart_reservation')          â”‚  â”‚
â”‚  â”‚          â†“ Restaura stock                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                        â”‚
â”‚                            â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    /api/cleanup-expired-reservations.ts (Mantenimiento)     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  GET  â†’ Verificar reservas expiradas (sin cambios)          â”‚  â”‚
â”‚  â”‚  POST â†’ Ejecutar limpieza (eliminar + restaurar stock)      â”‚  â”‚
â”‚  â”‚         â†“ supabase.rpc('cleanup_expired_reservations')      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                        â”‚
â”‚                            â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ PostgreSQL RPC
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE (Supabase/PostgreSQL)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Tabla: cart_reservations                                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  id              UUID (PK)                                   â”‚  â”‚
â”‚  â”‚  user_id         UUID (FK auth.users)                        â”‚  â”‚
â”‚  â”‚  product_id      UUID (FK productos)                         â”‚  â”‚
â”‚  â”‚  quantity        INT (> 0)                                   â”‚  â”‚
â”‚  â”‚  created_at      TIMESTAMPTZ (DEFAULT NOW())                â”‚  â”‚
â”‚  â”‚  expires_at      TIMESTAMPTZ (DEFAULT NOW() + 1 min)        â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  UNIQUE(user_id, product_id)  â† Evita duplicados           â”‚  â”‚
â”‚  â”‚  INDEX (user_id)               â† Performance                â”‚  â”‚
â”‚  â”‚  INDEX (expires_at)            â† Performance                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                        â”‚
â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                            â”‚         â”‚                              â”‚
â”‚                            â–¼         â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Tabla: productos                                            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  id              UUID (PK)                                   â”‚  â”‚
â”‚  â”‚  nombre          VARCHAR                                     â”‚  â”‚
â”‚  â”‚  stock_total     INT (se actualiza con reservas)            â”‚  â”‚
â”‚  â”‚  ...otros campos                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Funciones SQL (Stored Procedures)                           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  create_cart_reservation(product_id, quantity)              â”‚  â”‚
â”‚  â”‚    â€¢ Verifica stock disponible                              â”‚  â”‚
â”‚  â”‚    â€¢ Calcula diferencia vs reserva anterior                 â”‚  â”‚
â”‚  â”‚    â€¢ Si hay suficiente: INSERT/UPDATE con transacciÃ³n      â”‚  â”‚
â”‚  â”‚    â€¢ Resta stock atomicamente                               â”‚  â”‚
â”‚  â”‚    â€¢ Retorna {success, message}                             â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  delete_cart_reservation(product_id)                        â”‚  â”‚
â”‚  â”‚    â€¢ Obtiene cantidad reservada                             â”‚  â”‚
â”‚  â”‚    â€¢ DELETE registro de reserva                             â”‚  â”‚
â”‚  â”‚    â€¢ Restaura stock                                         â”‚  â”‚
â”‚  â”‚    â€¢ Retorna {success, message}                             â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  get_user_cart_reservations()                               â”‚  â”‚
â”‚  â”‚    â€¢ SELECT todas las reservas del usuario actual           â”‚  â”‚
â”‚  â”‚    â€¢ Calcula segundos_restantes = expires_at - NOW()       â”‚  â”‚
â”‚  â”‚    â€¢ Retorna array de reservas con tiempo                  â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  cleanup_expired_reservations()                             â”‚  â”‚
â”‚  â”‚    â€¢ SELECT reservas donde expires_at <= NOW()             â”‚  â”‚
â”‚  â”‚    â€¢ Para cada una: UPDATE productos.stock_total += qty   â”‚  â”‚
â”‚  â”‚    â€¢ DELETE todas las expiradas                            â”‚  â”‚
â”‚  â”‚    â€¢ Retorna {items_cleaned, stock_restored}              â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–²
                            â”‚
                    Cada 1 minuto
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRON JOB (Limpieza AutomÃ¡tica)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  OpciÃ³n 1: EasyCron                                                 â”‚
â”‚  OpciÃ³n 2: GitHub Actions                                          â”‚
â”‚  OpciÃ³n 3: Vercel Cron                                             â”‚
â”‚  OpciÃ³n 4: Trigger Manual en cada operaciÃ³n                        â”‚
â”‚                                                                       â”‚
â”‚  POST /api/cleanup-expired-reservations                            â”‚
â”‚  Authorization: Bearer <CRON_SECRET>                               â”‚
â”‚  â†“                                                                   â”‚
â”‚  supabase.rpc('cleanup_expired_reservations')                      â”‚
â”‚  â†“                                                                   â”‚
â”‚  Restaura stock automÃ¡ticamente                                    â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujo Completo: Usuario Compra un Producto

```
INICIO
  â”‚
  â”œâ”€ Usuario ve ProductCard
  â”‚  Stock: 10 unidades
  â”‚
  â”œâ”€ Click: "AÃ±adir al Carrito" (qty: 1)
  â”‚
  â”œâ”€ POST /api/reservas
  â”‚   {
  â”‚     "producto_id": "uuid-123",
  â”‚     "quantity": 1
  â”‚   }
  â”‚
  â”œâ”€ Backend:
  â”‚   1. supabase.rpc('create_cart_reservation', ...)
  â”‚   2. CREATE FUNCTION verifica:
  â”‚      - stock_total >= quantity? âœ“
  â”‚      - hay reserva anterior? NO
  â”‚      - INSERT en cart_reservations
  â”‚      - UPDATE productos SET stock = 9
  â”‚
  â”œâ”€ Respuesta: { success: true }
  â”‚
  â”œâ”€ Frontend:
  â”‚   1. setReserved(true)
  â”‚   2. startTimer(60)
  â”‚   3. Mostrar: "â±ï¸ Expira en 60s"
  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         OPCIÃ“N A: Usuario Compra             â”‚
  â”‚         (Dentro de 60 segundos)             â”‚
  â”‚                                             â”‚
  â”‚  â”œâ”€ Timer: 60s â†’ 30s â†’ 15s â†’ 5s             â”‚
  â”‚  â”‚                                          â”‚
  â”‚  â”œâ”€ Click: "Pagar"                          â”‚
  â”‚  â”‚                                          â”‚
  â”‚  â”œâ”€ POST /api/carrito/checkout              â”‚
  â”‚  â”‚   {                                      â”‚
  â”‚  â”‚     "items": [...]                       â”‚
  â”‚  â”‚   }                                      â”‚
  â”‚  â”‚                                          â”‚
  â”‚  â”œâ”€ Backend:                                â”‚
  â”‚  â”‚   1. Verifica reserva sigue activa       â”‚
  â”‚  â”‚   2. CREATE pedido                       â”‚
  â”‚  â”‚   3. DELETE reserva                      â”‚
  â”‚  â”‚   4. Stock permanece en 9 âœ“             â”‚
  â”‚  â”‚                                          â”‚
  â”‚  â””â”€ Ã‰XITO: Pedido #12345 creado             â”‚
  â”‚                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚
          â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                           â”‚
          â”‚                    OPCIÃ“N B: Usuario No Compra
          â”‚                    (Expira despuÃ©s de 60s)
          â”‚                                           â”‚
          â”‚                  â”œâ”€ Timer: 5s â†’ 0s       â”‚
          â”‚                  â”‚                       â”‚
          â”‚                  â”œâ”€ [AutomÃ¡tico cada min]â”‚
          â”‚                  â”‚  POST /cleanup        â”‚
          â”‚                  â”‚                       â”‚
          â”‚                  â”œâ”€ Backend:             â”‚
          â”‚                  â”‚   1. Busca expiradas  â”‚
          â”‚                  â”‚   2. ENCONTRADA:      â”‚
          â”‚                  â”‚      - product 123    â”‚
          â”‚                  â”‚      - qty: 1         â”‚
          â”‚                  â”‚   3. UPDATE productos â”‚
          â”‚                  â”‚      stock 9 â†’ 10     â”‚
          â”‚                  â”‚   4. DELETE reserva   â”‚
          â”‚                  â”‚                       â”‚
          â”‚                  â””â”€ Stock restaurado âœ“  â”‚
          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                          FIN
```

---

## ğŸ“ˆ Estado del Stock en Tiempo Real

```
PRODUCTO: iPhone 13 Pro
STOCK ORIGINAL: 10 unidades

TIME    â”‚ ACCIÃ“N                          â”‚ STOCK â”‚ RESERVADO
â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
10:00   â”‚ Stock inicial                   â”‚  10   â”‚    0
10:00   â”‚ Usuario A reserva 2 unidades    â”‚   8   â”‚    2
10:01   â”‚ Usuario B reserva 5 unidades    â”‚   3   â”‚    7
10:02   â”‚ Usuario C intenta 5 unidades    â”‚   3   â”‚    7     â† ERROR
        â”‚ "Stock insuficiente"            â”‚       â”‚
10:02   â”‚ Usuario A aumenta a 3 unidades  â”‚   7   â”‚    8
10:03   â”‚ Usuario B expira la reserva     â”‚  12   â”‚    3     â† LIMPIEZA
10:04   â”‚ Usuario C logra 4 unidades      â”‚   8   â”‚    7
...     â”‚ ...                             â”‚  ..   â”‚   ...
```

---

## ğŸ”’ Protecciones de Seguridad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PROTECCIONES CONTRA PROBLEMAS COMUNES         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  âŒ SOBREVENTA SIMULTÃNEA                             â”‚
â”‚     â””â”€ âœ… UNIQUE(user_id, product_id) + TransacciÃ³n  â”‚
â”‚                                                        â”‚
â”‚  âŒ CONDICIÃ“N DE CARRERA (Race Condition)             â”‚
â”‚     â””â”€ âœ… Transacciones ACID en PostgreSQL            â”‚
â”‚                                                        â”‚
â”‚  âŒ STOCK NEGATIVO                                     â”‚
â”‚     â””â”€ âœ… CHECK (quantity > 0) + ValidaciÃ³n SQL       â”‚
â”‚                                                        â”‚
â”‚  âŒ RESERVAS HUÃ‰RFANAS (No expiradas)                â”‚
â”‚     â””â”€ âœ… cleanup_expired_reservations() automÃ¡tico   â”‚
â”‚                                                        â”‚
â”‚  âŒ DATOS INCONSISTENTES                              â”‚
â”‚     â””â”€ âœ… Transacciones atÃ³micas + RLS               â”‚
â”‚                                                        â”‚
â”‚  âŒ ACCESO NO AUTORIZADO                              â”‚
â”‚     â””â”€ âœ… auth.uid() verificado + SECURITY DEFINER    â”‚
â”‚                                                        â”‚
â”‚  âŒ LIMPIEZA MANUAL SIN PERMISO                       â”‚
â”‚     â””â”€ âœ… Token CRON_SECRET protegido                 â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ Performance - Ãndices

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OPTIMIZACIONES PARA QUERYS RÃPIDAS                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  QUERY 1: Obtener reservas del usuario                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SELECT * FROM cart_reservations                â”‚  â”‚
â”‚  â”‚ WHERE user_id = 'uuid...'                      â”‚  â”‚
â”‚  â”‚                                                 â”‚  â”‚
â”‚  â”‚ ÃNDICE: idx_cart_reservations_user_id          â”‚  â”‚
â”‚  â”‚ O(log N) â†’ O(1) bÃºsqueda                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                        â”‚
â”‚  QUERY 2: Limpiar reservas expiradas                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SELECT * FROM cart_reservations                â”‚  â”‚
â”‚  â”‚ WHERE expires_at <= NOW()                      â”‚  â”‚
â”‚  â”‚                                                 â”‚  â”‚
â”‚  â”‚ ÃNDICE: idx_cart_reservations_expires_at       â”‚  â”‚
â”‚  â”‚ Evita full table scan                          â”‚  â”‚
â”‚  â”‚ O(log N) â†’ Procesar solo expiradas             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                        â”‚
â”‚  Resultado: Incluso con 1M de registros,             â”‚
â”‚            queries < 10ms âš¡                          â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§  LÃ³gica de Cambio de Cantidad

```
USUARIO CAMBIO CANTIDAD: 1 â†’ 3 unidades

stock_antes = 8  (10 original - 2 reservados)

CÃLCULO:
  cantidad_anterior = 1
  cantidad_nueva = 3
  stock_diff = 3 - 1 = 2  (necesita 2 mÃ¡s)

VALIDACIÃ“N:
  stock_disponible = 8
  stock_diff (2) <= stock_disponible (8)? âœ“

ACTUALIZACIÃ“N:
  1. UPDATE cart_reservations SET quantity = 3
  2. UPDATE productos SET stock = 8 - 2 = 6

RESULTADO:
  stock_nuevo = 6 (10 - 3 reservados - 1 otro usuario)
```

---

## ğŸ“± Estados Visuales en Frontend

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ESTADOS DEL CARRITO EN FRONTEND             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ESTADO 1: Producto no en carrito                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ iPhone 13 Pro                        â”‚             â”‚
â”‚  â”‚ Stock: 10                            â”‚             â”‚
â”‚  â”‚ [AÃ±adir al Carrito]                  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                         â”‚
â”‚  ESTADO 2: ReciÃ©n aÃ±adido (Timer activo)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ iPhone 13 Pro - Qty: 1               â”‚             â”‚
â”‚  â”‚ âœ… RESERVADO                         â”‚             â”‚
â”‚  â”‚ â±ï¸ Expira en: 58s                   â”‚             â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚             â”‚
â”‚  â”‚ [+] [-] [Eliminar]                   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                         â”‚
â”‚  ESTADO 3: PrÃ³ximo a expirar (color rojo)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ iPhone 13 Pro - Qty: 1               â”‚             â”‚
â”‚  â”‚ âš ï¸  EXPIRA PRONTO                   â”‚             â”‚
â”‚  â”‚ â±ï¸ Expira en: 8s                    â”‚ â† Rojo     â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚             â”‚
â”‚  â”‚ [+] [-] [Eliminar]                   â”‚             â”‚
â”‚  â”‚ ContinÃºa comprando â†’                 â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                         â”‚
â”‚  ESTADO 4: Expirado (eliminado)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ [VacÃ­o]                              â”‚             â”‚
â”‚  â”‚ Carrito vacÃ­o - ContinÃºa comprando   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ InteracciÃ³n API - Secuencia Temporal

```
FRONTEND                          BACKEND                       DATABASE
   â”‚                                â”‚                              â”‚
   â”‚  POST /api/reservas            â”‚                              â”‚
   â”‚  {producto, qty: 2}            â”‚                              â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
   â”‚                                â”‚  SELECT stock FROM productos â”‚
   â”‚                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                â”‚                    stock: 10  â”‚
   â”‚                                â”‚                              â”‚
   â”‚                                â”‚  SELECT quantity FROM cart... â”‚
   â”‚                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                â”‚             NULL (no existe)  â”‚
   â”‚                                â”‚                              â”‚
   â”‚                                â”‚  INSERT INTO cart_reservationsâ”‚
   â”‚                                â”‚  UPDATE productos SET stock=8 â”‚
   â”‚                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         (transacciÃ³n OK)      â”‚
   â”‚  {success: true}               â”‚                              â”‚
   â”‚                                â”‚                              â”‚
   â”‚  Frontend muestra timer        â”‚                              â”‚
   â”‚  "â±ï¸ Expira en 60s"          â”‚                              â”‚
   â”‚                                â”‚                              â”‚
   â”‚  [Espera 60 segundos]           â”‚                              â”‚
   â”‚                                â”‚                              â”‚
   â”‚                                â”‚<â”€ CRON JOB: POST /cleanup   â”‚
   â”‚                                â”‚                              â”‚
   â”‚                                â”‚  SELECT * FROM cart_        â”‚
   â”‚                                â”‚  reservations WHERE expires..â”‚
   â”‚                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                â”‚             (encontrada)      â”‚
   â”‚                                â”‚                              â”‚
   â”‚                                â”‚  UPDATE productos SET       â”‚
   â”‚                                â”‚  stock = stock + 2          â”‚
   â”‚                                â”‚  DELETE FROM cart_reserv...  â”‚
   â”‚                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                â”‚         (limpiado)           â”‚
   â”‚                                â”‚                              â”‚
   â”‚  Frontend: Timer = 0           â”‚                              â”‚
   â”‚  Carrito se vacÃ­a (polling)    â”‚                              â”‚
   â”‚                                â”‚                              â”‚
```

---

## ğŸ’¾ Transacciones de Stock

```
ESCENARIO: Dos usuarios intentan lo mismo

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  TRANSACCIÃ“N USUARIO A                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  BEGIN                                                 â•‘
â•‘    SELECT stock FROM productos WHERE id = 'uuid'      â•‘
â•‘    stock = 10  âœ“                                      â•‘
â•‘                                                        â•‘
â•‘    INSERT INTO cart_reservations                      â•‘
â•‘    VALUES (user_a, uuid, 3, ...)                      â•‘
â•‘    Lock adquirido en row                              â•‘
â•‘                                                        â•‘
â•‘    UPDATE productos SET stock = 7                     â•‘
â•‘  COMMIT âœ… EXITOSO                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          â•‘
                          â•‘ User B intenta en paralelo
                          â•‘
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  TRANSACCIÃ“N USUARIO B                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  BEGIN                                                 â•‘
â•‘    SELECT stock FROM productos WHERE id = 'uuid'      â•‘
â•‘    stock = 10  (snapshot anterior a User A)           â•‘
â•‘                                                        â•‘
â•‘    INSERT INTO cart_reservations                      â•‘
â•‘    VALUES (user_b, uuid, 5, ...)                      â•‘
â•‘    âŒ UNIQUE CONSTRAINT VIOLATION                     â•‘
â•‘    Usuario A ya reservÃ³ el mismo producto             â•‘
â•‘                                                        â•‘
â•‘  ROLLBACK âŒ RECHAZADO                                â•‘
â•‘  Mensaje: "Espera tu turno, es para uno por usuario"  â•‘
â•‘                                                        â•‘
â•‘  *O si fuera otro producto, continuarÃ­a:              â•‘
â•‘    UPDATE productos SET stock = 5                     â•‘
â•‘    âŒ INSUFICIENTE: 10 - 5 (A) = 5, pero B quiere 5  â•‘
â•‘  ROLLBACK âŒ "Stock insuficiente"                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RESULTADO: Ambas transacciones son ACID
- Atomicidad: Todo o nada
- Consistencia: Stock siempre correcto
- Aislamiento: No interfieren
- Durabilidad: Se persisten
```

---

## ğŸ“Š Monitoreo - Dashboards

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MÃ‰TRICAS EN TIEMPO REAL                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  Reservas Activas:     347                           â”‚
â”‚  â”œâ”€ Usuarios Ãºnicos:    280                          â”‚
â”‚  â”œâ”€ Productos:          145                          â”‚
â”‚  â””â”€ Stock "congelado":  1,234 unidades              â”‚
â”‚                                                        â”‚
â”‚  Proximas a Expirar:   12 (< 30s)                    â”‚
â”‚  â”œâ”€ iPhone 13:          3                           â”‚
â”‚  â”œâ”€ Samsung S22:        5                           â”‚
â”‚  â””â”€ iPad Air:           4                           â”‚
â”‚                                                        â”‚
â”‚  Limpieza Ãšltima:       Hace 15s                     â”‚
â”‚  â”œâ”€ Items eliminados:   5                           â”‚
â”‚  â”œâ”€ Stock restaurado:   23 unidades                 â”‚
â”‚  â””â”€ Tiempo ejecuciÃ³n:   124ms                       â”‚
â”‚                                                        â”‚
â”‚  Tasa ConversiÃ³n:       78%                          â”‚
â”‚  â”œâ”€ Completadas:        342 ordenes                 â”‚
â”‚  â”œâ”€ Expiradas:          95 carritos                 â”‚
â”‚  â””â”€ Pendientes:         347 reservas                â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

Â¡Sistema seguro, rÃ¡pido y escalable! ğŸš€
