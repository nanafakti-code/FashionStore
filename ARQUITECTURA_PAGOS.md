# ğŸ—ï¸ Arquitectura - Sistema de Pagos FashionStore

## Diagrama General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLIENTE (NAVEGADOR)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Carrito.tsx â†’ [Pagar] â†’ POST /api/stripe/create-session       â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â†“                                     â”‚
â”‚                    [FRONTEND VALIDA]                            â”‚
â”‚                    âœ“ Email vÃ¡lido                               â”‚
â”‚                    âœ“ Items en carrito                           â”‚
â”‚                    âœ“ DirecciÃ³n completa                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           BACKEND - /api/stripe/create-session.ts               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [1] VALIDAR DATOS (servidor)                                  â”‚
â”‚      âœ“ Email                                                    â”‚
â”‚      âœ“ Monto                                                    â”‚
â”‚      âœ“ Items                                                    â”‚
â”‚                                                                 â”‚
â”‚  [2] CREAR ORDEN EN SUPABASE â­ CRÃTICO                         â”‚
â”‚      INSERT ordenes (                                           â”‚
â”‚        numero_orden: FS-20260119-1234                           â”‚
â”‚        estado: 'Pendiente',                                     â”‚
â”‚        total: 99900,                                            â”‚
â”‚        email_cliente: cliente@example.com,                      â”‚
â”‚        ...                                                      â”‚
â”‚      )                                                          â”‚
â”‚      â†’ Retorna: order.id = abc123                               â”‚
â”‚                                                                 â”‚
â”‚  [3] CREAR ITEMS EN SUPABASE                                   â”‚
â”‚      INSERT items_orden Ã—N (uno por cada producto)             â”‚
â”‚      â†’ Vinculados a order.id                                    â”‚
â”‚                                                                 â”‚
â”‚  [4] CREAR SESIÃ“N STRIPE                                       â”‚
â”‚      stripe.checkout.sessions.create({                          â”‚
â”‚        line_items: [...],                                       â”‚
â”‚        metadata: {                                              â”‚
â”‚          order_id: "abc123" â­ CRÃTICO,                         â”‚
â”‚          user_id: "xyz",                                        â”‚
â”‚          email: "cliente@example.com",                          â”‚
â”‚          ...                                                    â”‚
â”‚        }                                                        â”‚
â”‚      })                                                         â”‚
â”‚      â†’ Retorna: session.id = cs_test_xxxxx                     â”‚
â”‚                                                                 â”‚
â”‚  [5] RESPONDER AL CLIENTE                                      â”‚
â”‚      return {                                                   â”‚
â”‚        sessionId: "cs_test_xxxxx",                              â”‚
â”‚        url: "https://checkout.stripe.com/...",                 â”‚
â”‚        orderId: "abc123"  (para tracking)                       â”‚
â”‚      }                                                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        STRIPE CHECKOUT                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Stripe redirige a: https://checkout.stripe.com/...            â”‚
â”‚                                                                 â”‚
â”‚  Cliente:                                                       â”‚
â”‚  [Ingresa tarjeta] â†’ [Click Pagar] â†’ Stripe procesa pago      â”‚
â”‚                                                                 â”‚
â”‚  Stripe confirma: âœ… Pago exitoso                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           STRIPE â†’ WEBHOOK â†’ /api/stripe/webhook.ts             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Evento: checkout.session.completed                            â”‚
â”‚  POST /api/stripe/webhook                                      â”‚
â”‚  Header: stripe-signature: t=xxxxx,v1=yyyyy                    â”‚
â”‚  Body: {                                                        â”‚
â”‚    "id": "evt_xxxxx",                                           â”‚
â”‚    "type": "checkout.session.completed",                        â”‚
â”‚    "data": {                                                    â”‚
â”‚      "object": {                                                â”‚
â”‚        "id": "cs_test_xxxxx",                                   â”‚
â”‚        "amount_total": 99900,                                   â”‚
â”‚        "metadata": {                                            â”‚
â”‚          "order_id": "abc123" â­ USAR ESTO                      â”‚
â”‚        }                                                        â”‚
â”‚      }                                                          â”‚
â”‚    }                                                            â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  [1] VALIDAR FIRMA âœ…                                           â”‚
â”‚      stripe.webhooks.constructEvent(body, signature, secret)   â”‚
â”‚      Si falla â†’ return 401 Unauthorized                        â”‚
â”‚                                                                 â”‚
â”‚  [2] OBTENER order_id DE METADATA âœ…                           â”‚
â”‚      const orderId = metadata.order_id = "abc123"              â”‚
â”‚                                                                 â”‚
â”‚  [3] OBTENER ORDEN DE SUPABASE âœ…                              â”‚
â”‚      SELECT * FROM ordenes WHERE id = "abc123"                 â”‚
â”‚      â†’ Retorna: order { id, total, email_cliente, ... }        â”‚
â”‚                                                                 â”‚
â”‚  [4] VALIDAR MONTO (ANTI-FRAUDE) âœ… CRÃTICO                    â”‚
â”‚      if (order.total !== session.amount_total / 100) {         â”‚
â”‚        console.error("Monto no coincide - FRAUDE POTENCIAL")   â”‚
â”‚        return  // NO ACTUALIZAR                                â”‚
â”‚      }                                                          â”‚
â”‚                                                                 â”‚
â”‚  [5] ACTUALIZAR ORDEN EN SUPABASE âœ…                           â”‚
â”‚      UPDATE ordenes SET                                        â”‚
â”‚        estado = 'Pagado',                                       â”‚
â”‚        stripe_payment_intent = session.payment_intent,         â”‚
â”‚        fecha_pago = NOW()                                      â”‚
â”‚      WHERE id = "abc123"                                        â”‚
â”‚                                                                 â”‚
â”‚  [6] OBTENER ITEMS PARA EMAIL âœ…                               â”‚
â”‚      SELECT * FROM items_orden WHERE orden_id = "abc123"       â”‚
â”‚                                                                 â”‚
â”‚  [7] ENVIAR EMAIL AL CLIENTE âœ…                                â”‚
â”‚      sendOrderConfirmationEmail({                              â”‚
â”‚        numero_orden: "FS-20260119-1234",                        â”‚
â”‚        email: "cliente@example.com",                            â”‚
â”‚        items: [...],                                           â”‚
â”‚        total: 99900                                            â”‚
â”‚      })                                                         â”‚
â”‚      â†’ Email: "Pedido confirmado FS-20260119-1234"             â”‚
â”‚                                                                 â”‚
â”‚  [8] ENVIAR EMAIL AL ADMIN âœ…                                  â”‚
â”‚      sendAdminNotificationEmail({                              â”‚
â”‚        type: 'new_order',                                       â”‚
â”‚        order_number: "FS-20260119-1234",                        â”‚
â”‚        customer_email: "cliente@example.com",                   â”‚
â”‚        total: 99900                                            â”‚
â”‚      })                                                         â”‚
â”‚      â†’ Email a: raafaablanco@gmail.com                          â”‚
â”‚      â†’ Email: "Nuevo pedido: FS-20260119-1234"                 â”‚
â”‚                                                                 â”‚
â”‚  [9] LIMPIAR CARRITO (si usuario registrado) âœ…                â”‚
â”‚      DELETE FROM cart_items WHERE user_id = "xyz"              â”‚
â”‚      DELETE FROM cart_reservations WHERE user_id = "xyz"       â”‚
â”‚                                                                 â”‚
â”‚  [10] RESPONDER A STRIPE CON 200 OK âœ…                         â”‚
â”‚       return {                                                  â”‚
â”‚         status: 200,                                            â”‚
â”‚         received: true,                                         â”‚
â”‚         event_id: "evt_xxxxx"                                   â”‚
â”‚       }                                                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STRIPE CONFIRMA WEBHOOK ENTREGADO                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Stripe Dashboard â†’ Events:                                     â”‚
â”‚  checkout.session.completed â†’ Status: âœ… Delivered              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BASE DE DATOS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ordenes:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ id          â”‚ FS-20260119-1234  â”‚ estado  â”‚ Pagado   â”‚   â”‚
â”‚  â”‚ total       â”‚ 99900             â”‚ email   â”‚ clie...  â”‚   â”‚
â”‚  â”‚ fecha_pago  â”‚ 2026-01-19 14:30  â”‚ stripe  â”‚ cs_...   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  items_orden:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ orden_id  â”‚ producto_nombre â”‚ cantidad â”‚ precio    â”‚   â”‚
â”‚  â”‚ abc123    â”‚ iPhone 15 Pro   â”‚ 1        â”‚ 49950     â”‚   â”‚
â”‚  â”‚ abc123    â”‚ Funda iPhone    â”‚ 2        â”‚ 25000     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REDIRECCIÃ“N A CLIENTE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Stripe redirige a: /checkout/success?session_id=cs_test_xxxxx â”‚
â”‚                                                                 â”‚
â”‚  Cliente ve: âœ… Pedido confirmado                              â”‚
â”‚              - NÃºmero de orden                                 â”‚
â”‚              - Total pagado                                    â”‚
â”‚              - Items comprados                                 â”‚
â”‚              - DirecciÃ³n de envÃ­o                              â”‚
â”‚                                                                 â”‚
â”‚  Bandeja entrada:                                              â”‚
â”‚  âœ… Email de confirmaciÃ³n de pedido                            â”‚
â”‚  âœ… Email con nÃºmero de orden y detalles                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Datos

```
CLIENTE
   â†“
   â””â†’ /api/stripe/create-session
                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                   â†“
    SUPABASE            STRIPE
    (create order)      (create session)
        â†“                   â†“
      (datos)            (session.id)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
            CLIENTE â†’ STRIPE CHECKOUT
                  â†“
            CLIENTE PAGA
                  â†“
        STRIPE â†’ WEBHOOK
                  â†“
        /api/stripe/webhook
                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                   â†“         â†“
    SUPABASE            EMAIL      LOGGER
    (update status)   (confirmar)  (logs)
        â†“                   â†“
      PAGADO         CLI + ADMIN
```

---

## Seguridad en Capas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAPA 1: VALIDACIÃ“N EN CLIENTE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Email vÃ¡lido                                            â”‚
â”‚ âœ“ Items en carrito                                        â”‚
â”‚ âœ“ Datos completos                                         â”‚
â”‚ (Usuario puede bypassear - no confiar)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAPA 2: VALIDACIÃ“N EN SERVIDOR                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Email vÃ¡lido (regex)                                    â”‚
â”‚ âœ“ Monto > 0                                               â”‚
â”‚ âœ“ Items no vacÃ­o                                          â”‚
â”‚ (ValidaciÃ³n bÃ¡sica)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAPA 3: DATOS EN BD                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Orden registrada (antes de pago)                        â”‚
â”‚ âœ“ Items registrados (asociados a orden)                   â”‚
â”‚ âœ“ Estado: Pendiente (esperando confirmaciÃ³n)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAPA 4: PAGO EN STRIPE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Tarjeta validada                                        â”‚
â”‚ âœ“ Fondos disponibles                                      â”‚
â”‚ âœ“ SesiÃ³n creada con order_id en metadata                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CAPA 5: WEBHOOK SEGURO                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Firma validada (imposible falsificar)                   â”‚
â”‚ âœ“ Order_id verificado (debe existir en BD)                â”‚
â”‚ âœ“ Monto validado (coincide con BD)                        â”‚
â”‚ âœ“ Estado actualizado (solo desde webhook)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Manejo de Errores

```
FALLO EN CLIENTE
  â†“
  âœ“ Mostrar error amigable
  âœ“ Orden permanece en BD (estado: Pendiente)
  âœ“ Cliente puede reintentar

FALLO EN create-session
  â†“
  âœ“ Orden NO creada (rollback)
  âœ“ Stripe NO creada
  âœ“ Responder error al cliente

FALLO EN STRIPE
  â†“
  âœ“ Pago no procesado
  âœ“ Orden sigue en estado Pendiente
  âœ“ Cliente puede reintentar

FALLO EN WEBHOOK
  â†“
  âœ“ Stripe reintenta entregar
  âœ“ Admin notificado del error
  âœ“ Logs registran el problema
  âœ“ Manual: Admin actualiza orden

MONTO NO COINCIDE (FRAUDE)
  â†“
  âœ“ Webhook RECHAZA actualizaciÃ³n
  âœ“ Orden permanece en Pendiente
  âœ“ Logs registran anomalÃ­a
  âœ“ Admin notificado
```

---

**Arquitectura**: Profesional, segura y lista para producciÃ³n
**Nivel de seguridad**: ğŸŸ¢ ALTO
**Redundancia**: Webhook reintentable, logs completos, manejo robusto de errores
