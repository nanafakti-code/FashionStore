# ğŸ¨ DIAGRAMA VISUAL - SISTEMA DE CARRITO

## Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FASHIONSTORE CARRITO                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              Frontend
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  Componentesâ”‚
                          â”‚   React/    â”‚
                          â”‚   Astro     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            â”‚            â”‚
                    â–¼            â–¼            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ useCart()    â”‚ â”‚ Local    â”‚ â”‚ Supabase â”‚
            â”‚  Hook React  â”‚ â”‚ Storage  â”‚ â”‚    DB    â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚              â”‚            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   cartService.ts
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Auto-detecta autenticaciÃ³n            â”‚
   â”‚   â€¢ Usuario autenticado â†’ BD (RLS)      â”‚
   â”‚   â€¢ Usuario invitado â†’ localStorage     â”‚
   â”‚   â€¢ MigraciÃ³n automÃ¡tica al login       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
        â–¼                     â–¼
   BD Supabase         localStorage
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ cart_items  â”‚    â”‚ guest_cart   â”‚
   â”‚  (RLS ON)   â”‚    â”‚  (JSON)      â”‚
   â”‚ user_id âœ“   â”‚    â”‚ sessionId    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo: Usuario Guest â†’ Autenticado

```
â”Œâ”€ FASE 1: USUARIO INVITADO â”€â”
â”‚                            â”‚
â”‚ Navega a tienda            â”‚
â”‚ Sin autenticaciÃ³n          â”‚
â”‚                            â”‚
â”‚ LocalStorage:              â”‚
â”‚ â”œâ”€ sessionId               â”‚
â”‚ â””â”€ carrito: []             â”‚
â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ "AÃ±adir al carrito"
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ addToGuestCart() â”‚
   â”‚ localStorage â†   â”‚
   â”‚ [item1, item2]   â”‚
   â”‚ Badge: 2         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FASE 2: USUARIO HACE LOGIN  â”‚
   â”‚                            â”‚
   â”‚ Clic: "Iniciar sesiÃ³n"     â”‚
   â”‚ Se autentica               â”‚
   â”‚ auth.uid() = "user-123"    â”‚
   â”‚                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Hook useCart detecta:
             â”‚ getCurrentUser() â‰  null
             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ migrateGuestCartToUser() â”‚
   â”‚                          â”‚
   â”‚ 1. Lee localStorage      â”‚
   â”‚    {items: [...]}        â”‚
   â”‚                          â”‚
   â”‚ 2. EnvÃ­a a Supabase RPC  â”‚
   â”‚    migrate_guest_...()   â”‚
   â”‚                          â”‚
   â”‚ 3. Supabase procesa:     â”‚
   â”‚    â”œâ”€ Para cada item:    â”‚
   â”‚    â”œâ”€ Â¿Existe en BD?     â”‚
   â”‚    â”‚   SI â†’ suma qty     â”‚
   â”‚    â”‚   NO â†’ crea nuevo   â”‚
   â”‚    â””â”€ Inserta en BD      â”‚
   â”‚                          â”‚
   â”‚ 4. Limpia localStorage   â”‚
   â”‚    sessionId deleted     â”‚
   â”‚    cart deleted          â”‚
   â”‚                          â”‚
   â”‚ 5. Dispara evento:       â”‚
   â”‚    authCartUpdated       â”‚
   â”‚                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FASE 3: USUARIO      â”‚
   â”‚ AUTENTICADO          â”‚
   â”‚                      â”‚
   â”‚ BD Supabase:         â”‚
   â”‚ cart_items:          â”‚
   â”‚ â”œâ”€ id: uuid-1        â”‚
   â”‚ â”œâ”€ user_id: user-123 â”‚
   â”‚ â”œâ”€ product_id: p-1   â”‚
   â”‚ â”œâ”€ quantity: 2       â”‚
   â”‚ â””â”€ ...               â”‚
   â”‚                      â”‚
   â”‚ RLS: user_id =       â”‚
   â”‚      auth.uid()      â”‚
   â”‚      (GARANTIZADO)   â”‚
   â”‚                      â”‚
   â”‚ Puede:               â”‚
   â”‚ âœ“ Ver carrito        â”‚
   â”‚ âœ“ Editar qty         â”‚
   â”‚ âœ“ Eliminar items     â”‚
   â”‚ âœ“ Checkout           â”‚
   â”‚                      â”‚
   â”‚ No puede:            â”‚
   â”‚ âœ— Ver otro carrito   â”‚
   â”‚ âœ— Modificar otro     â”‚
   â”‚                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Estructura de Datos

### localStorage (Guest)

```javascript
// fashionstore_guest_cart
[
  {
    product_id: "uuid-abc123",
    product_name: "Camiseta Premium",
    quantity: 2,
    talla: "M",
    color: "Azul",
    precio_unitario: 2999,
    product_image: "https://..."
  },
  {
    product_id: "uuid-def456",
    product_name: "PantalÃ³n Denim",
    quantity: 1,
    talla: "32",
    color: null,
    precio_unitario: 4999,
    product_image: "https://..."
  }
]

// fashionstore_session_id
"guest_1705315200_a1b2c3d4e5f6"
```

### Supabase BD (Authenticated)

```sql
cart_items TABLE:

id              | uuid-111
user_id         | auth-user-123
product_id      | product-abc123
quantity        | 2
talla           | M
color           | Azul
precio_unitario | 2999
created_at      | 2026-01-15 10:30:00
updated_at      | 2026-01-15 10:30:00

---

id              | uuid-222
user_id         | auth-user-123
product_id      | product-def456
quantity        | 1
talla           | 32
color           | null
precio_unitario | 4999
created_at      | 2026-01-15 10:31:00
updated_at      | 2026-01-15 10:31:00
```

---

## Tipos de Operaciones

### Carrito Invitado (localStorage)

```
User Action                    FunciÃ³n                   Almacenamiento
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AÃ±adir al carrito      â†’  addToGuestCart()      â†’  localStorage
Cambiar cantidad       â†’  updateGuestCartItem() â†’  localStorage
Eliminar item          â†’  removeFromGuestCart() â†’  localStorage
Vaciar carrito         â†’  clearGuestCart()      â†’  localStorage

CaracterÃ­sticas:
â€¢ RÃ¡pido (sin red)
â€¢ SÃ­ncrono
â€¢ Limitado a 5MB
â€¢ Se pierde al limpiar cache
```

### Carrito Autenticado (BD)

```
User Action                    FunciÃ³n                      Almacenamiento
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Obtener carrito        â†’  getAuthenticatedCart()      â†’  BD Supabase
AÃ±adir al carrito      â†’  addToAuthenticatedCart()    â†’  BD Supabase
Cambiar cantidad       â†’  updateAuthenticatedCartItem()â†’ BD Supabase
Eliminar item          â†’  removeFromAuthenticatedCart()â†’ BD Supabase
Vaciar carrito         â†’  clearAuthenticatedCart()    â†’  BD Supabase

CaracterÃ­sticas:
â€¢ AsÃ­ncrono (latencia)
â€¢ Persistente (respaldado)
â€¢ Escalable (ilimitado)
â€¢ Sincronizado entre dispositivos
â€¢ Protegido por RLS
```

---

## Security: RLS en acciÃ³n

### Escenario: Usuario A intenta acceder carrito de Usuario B

```
Supabase DB Request:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT * FROM cart_items                â”‚
â”‚ WHERE user_id = 'user-b'                â”‚
â”‚                                         â”‚
â”‚ Usuario actual: auth.uid() = 'user-a'  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€ RLS Policy Check â”€â”
    â”‚                    â”‚
    â”‚ auth.uid() =       â”‚
    â”‚ 'user-a'           â”‚
    â”‚                    â”‚
    â”‚ user_id =          â”‚
    â”‚ 'user-b'           â”‚
    â”‚                    â”‚
    â”‚ user-a â‰  user-b    â”‚
    â”‚                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  403 FORBIDDEN   â”‚
    â”‚  Acceso denegado â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Escenario: Usuario A accede carrito PROPIO

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT * FROM cart_items                â”‚
â”‚ WHERE user_id = 'user-a'                â”‚
â”‚                                         â”‚
â”‚ Usuario actual: auth.uid() = 'user-a'  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€ RLS Policy Check â”€â”
    â”‚                    â”‚
    â”‚ auth.uid() =       â”‚
    â”‚ 'user-a'           â”‚
    â”‚                    â”‚
    â”‚ user_id =          â”‚
    â”‚ 'user-a'           â”‚
    â”‚                    â”‚
    â”‚ user-a = user-a âœ“ â”‚
    â”‚                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  200 OK          â”‚
    â”‚ items: [...]     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de Componentes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      src/pages/tienda                        â”‚
â”‚                    (Ver productos)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
       â”‚                                                  â”‚
       â–¼                                                  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ProductCard.astroâ”‚                         â”‚ Header.astro     â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚ â”‚ Product info â”‚ â”‚                         â”‚ â”‚ Logo         â”‚ â”‚
  â”‚ â”‚ Image        â”‚ â”‚                         â”‚ â”‚ Search       â”‚ â”‚
  â”‚ â”‚ Name         â”‚ â”‚                         â”‚ â”‚ CartBadge    â”‚ â”‚
  â”‚ â”‚ Price        â”‚ â”‚                         â”‚ â”‚ (Muestra qty)â”‚ â”‚
  â”‚ â”‚              â”‚ â”‚                         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚ â”‚ + ADD button â”‚ â”‚                         â”‚                  â”‚
  â”‚ â”‚ (AddToCart   â”‚ â”‚                         â”‚ Actualiza cuando â”‚
  â”‚ â”‚  Button)     â”‚ â”‚                         â”‚ carrito cambia   â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                         â”‚                  â”‚
  â”‚        â”‚         â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚        â”‚         â”‚
  â”‚        â”‚         â”‚ onClick
  â”‚        â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  useCart().addItem(                â”‚
  â”‚                   â”‚    productId, name, price, image    â”‚
  â”‚                   â”‚  )                                  â”‚
  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚                              â”‚
  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   â”‚                     â”‚
  â”‚           (Sin auth)            (Con auth)
  â”‚              â”‚                     â”‚
  â”‚              â–¼                     â–¼
  â”‚         localStorage         Supabase BD
  â”‚         [carrito]            (cart_items)
  â”‚                                    â”‚
  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚                   â”‚
  â”‚                   â–¼
  â”‚            Badge actualiza
  â”‚            evento dispara
  â”‚
  â””â”€ Fin add â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   src/pages/cart                          â”‚
â”‚              (Ver y editar carrito)                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ CartPage()                                           â”‚ â”‚
â”‚ â”‚  â”œâ”€ CartItemsList()                                 â”‚ â”‚
â”‚ â”‚  â”‚  â”œâ”€ Items: [...]                                â”‚ â”‚
â”‚ â”‚  â”‚  â”œâ”€ Qty controls (Â±, input)                     â”‚ â”‚
â”‚ â”‚  â”‚  â”œâ”€ Remove buttons                              â”‚ â”‚
â”‚ â”‚  â”‚  â””â”€ updateQuantity(), removeItem()              â”‚ â”‚
â”‚ â”‚  â”‚                                                  â”‚ â”‚
â”‚ â”‚  â””â”€ CartSummary()                                   â”‚ â”‚
â”‚ â”‚     â”œâ”€ Subtotal                                    â”‚ â”‚
â”‚ â”‚     â”œâ”€ IVA (21%)                                   â”‚ â”‚
â”‚ â”‚     â”œâ”€ Total                                       â”‚ â”‚
â”‚ â”‚     â””â”€ Checkout button                             â”‚ â”‚
â”‚ â”‚                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚ Actualiza desde: localStorage o BD                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## GestiÃ³n de Estado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    useCart() Hook                            â”‚
â”‚                  (Estado central)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Estado:                                                      â”‚
â”‚ â€¢ items: CartItem[]                                          â”‚
â”‚ â€¢ summary: { subtotal, tax, total, itemCount }             â”‚
â”‚ â€¢ isLoading: boolean                                         â”‚
â”‚ â€¢ error: string | null                                       â”‚
â”‚ â€¢ isProcessing: boolean                                      â”‚
â”‚ â€¢ isAuthenticated: boolean                                   â”‚
â”‚                                                              â”‚
â”‚ MÃ©todos:                                                     â”‚
â”‚ â€¢ loadCart()                                                 â”‚
â”‚ â€¢ addItem(productId, ...)                                   â”‚
â”‚ â€¢ updateQuantity(itemId, quantity)                          â”‚
â”‚ â€¢ removeItem(itemId)                                         â”‚
â”‚ â€¢ clear()                                                    â”‚
â”‚ â€¢ getItemCount()                                             â”‚
â”‚ â€¢ migrateCart()                                              â”‚
â”‚                                                              â”‚
â”‚ Listeners:                                                   â”‚
â”‚ â€¢ authCartUpdated (evento BD)                               â”‚
â”‚ â€¢ guestCartUpdated (evento localStorage)                    â”‚
â”‚ â€¢ Cambios en autenticaciÃ³n                                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                â”‚
       â”‚ Actualiza estado               â”‚
       â–¼                                â–¼
   localStorage              Supabase (BD)
   [JSON]                    (cart_items)
   SÃ­ncrono                  AsÃ­ncrono
```

---

## CÃ¡lculos de Totales

```
Items en carrito:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Product A: $2999 Ã— 2 = $5998          â”‚
â”‚ Product B: $4999 Ã— 1 = $4999          â”‚
â”‚ Product C: $999 Ã— 3 = $2997           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         Subtotal: $13,994
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
        â–¼                 â–¼
    IVA 21%         Total
    Ã— 0.21       $13,994
    â”€â”€â”€â”€â”€         $2,939
    $2,939        â”€â”€â”€â”€â”€
               $16,933
```

---

## Timeline: ImplementaciÃ³n

```
                        ImplementaciÃ³n
                         Proyectada
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

DÃ­a 1 (Hoy):
  09:00 â”œâ”€ AnÃ¡lisis de requisitos
  10:00 â”œâ”€ DiseÃ±o de BD (Schema)
  11:00 â”œâ”€ Crear tabla + RLS
  12:00 â”œâ”€ Funciones SQL
  13:00 â”œâ”€ ALMUERZO
  14:00 â”œâ”€ Servicio cartService.ts
  15:30 â”œâ”€ Hook useCart.ts
  16:30 â”œâ”€ Componentes React
  17:30 â”œâ”€ DocumentaciÃ³n completa
  18:00 â”œâ”€ Testing bÃ¡sico
  19:00 â””â”€ âœ… COMPLETADO

Tiempo total: ~10 horas
Tiempo integraciÃ³n: ~30 minutos (por desarrollador)
```

---

## Tech Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           FRONTEND (Cliente)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  â€¢ Astro 5.0 (Framework)                   â”‚
â”‚  â€¢ React (Componentes interactivos)        â”‚
â”‚  â€¢ TypeScript (Type Safety)                â”‚
â”‚  â€¢ TailwindCSS (Estilos)                   â”‚
â”‚                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        COMUNICACIÃ“N (API Real-time)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  â€¢ Supabase Client JS                      â”‚
â”‚  â€¢ PostgreSQL Queries                      â”‚
â”‚  â€¢ RPC Functions                           â”‚
â”‚                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      BACKEND (Servidor de BD)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  â€¢ Supabase (PostgreSQL hosting)           â”‚
â”‚  â€¢ Row Level Security (RLS)                â”‚
â”‚  â€¢ Auth (PostgreSQL auth.users)            â”‚
â”‚  â€¢ Storage (ImÃ¡genes)                      â”‚
â”‚                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ALMACENAMIENTO (Local + Remoto)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  â€¢ localStorage (Invitados)                â”‚
â”‚  â€¢ PostgreSQL (Autenticados)               â”‚
â”‚  â€¢ Backups automÃ¡ticos (Supabase)          â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decisiones de Arquitectura

```
                    Â¿DÃ³nde guardar carrito?
                            â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                     â”‚
           Â¿Autenticado?          Â¿Invitado?
                 â”‚                     â”‚
              SI â”‚ NO                  â”‚
                 â”‚                     â”‚
                 â–¼                     â–¼
            Supabase               localStorage
            (BD RLS)               (JSON sync)
                 â”‚                     â”‚
                 â”œâ”€ Persistente       â”œâ”€ Temporal
                 â”œâ”€ Sincronizado      â”œâ”€ RÃ¡pido
                 â”œâ”€ Multi-dispositivo â”œâ”€ LÃ­mite 5MB
                 â”œâ”€ Respaldado        â”œâ”€ Se pierde
                 â”œâ”€ Seguro (RLS)      â””â”€ No sync
                 â””â”€ Escalable
```

---

**Visual Diagrams - Shopping Cart System v1.0**  
*Implementado: 15 de enero de 2026*
